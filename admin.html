<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Virtual Queue â€” Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-3">Admin Dashboard</h1>

    <div class="mb-3">
      <select id="admin-location" class="form-select w-50 mb-2">
        <option value="templeA">Temple A</option>
        <option value="canteen1">Canteen 1</option>
      </select>
      <button id="callNextBtn" class="btn btn-success">Call Next</button>
      <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
    </div>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>Number</th><th>Name</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="queue-body"></tbody>
    </table>

    <hr/>
    <h5>Current serving: <span id="admin-serving">-</span></h5>
    <p class="text-muted small">Click "Call Next" to call the smallest waiting number.</p>


    
    <hr>
    <h3 class="mt-4">Analytics</h3>

    <h5 class="mb-3">Average Waiting Time:
        <span id="avgWait" class="fw-bold">Calculating...</span>
    </h5>

    <canvas id="peakChart" style="max-width: 600px; margin: auto;"></canvas>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   


  </div>

  <script type="module" src="admin.js"></script>

 
  <script>
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const db = getDatabase();
    const queueRef = ref(db, 'queue');

    let hourLabels = Array.from({length: 24}, (_, i) => `${i}:00`);
    let servedPerHour = new Array(24).fill(0);
    let chart;

    onValue(queueRef, (snapshot) => {
        const data = snapshot.val();
        let servingTimes = [];
        servedPerHour.fill(0);

        for (let key in data) {
            const user = data[key];
            if (user.status === "done" && user.joinedAt && user.servedAt) {
                servingTimes.push(user.servedAt - user.joinedAt);
                const hour = new Date(user.servedAt).getHours();
                servedPerHour[hour]++;
            }
        }

        const avgWait = servingTimes.length > 0
            ? (servingTimes.reduce((a,b)=>a+b) / servingTimes.length) / 60000
            : 0;
        document.getElementById("avgWait").textContent =
            avgWait.toFixed(1) + " mins";

        updatePeakChart();
    });

    function updatePeakChart() {
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById("peakChart"), {
            type: 'bar',
            data: {
                labels: hourLabels,
                datasets: [{
                    label: 'Users Served Per Hour',
                    data: servedPerHour
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } }
            }
        });
    }
  </script>
  


</body>
</html>
