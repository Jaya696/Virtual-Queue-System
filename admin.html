<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Virtual Queue — Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { padding: 18px; }
    #peakChart { max-width: 760px; display:block; margin: 18px auto; }
    .small-muted { color: #666; font-size: .9rem; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-3">Admin Dashboard</h1>

    <div class="mb-3 d-flex align-items-center gap-2">
      <select id="admin-location" class="form-select w-50">
        <option value="templeA">Temple A</option>
        <option value="canteen1">Canteen 1</option>
      </select>
      <button id="callNextBtn" class="btn btn-success">Call Next</button>
      <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
    </div>

    <table class="table table-striped">
      <thead>
        <tr><th style="width:90px">Number</th><th>Name</th><th style="width:120px">Status</th><th style="width:140px">Actions</th></tr>
      </thead>
      <tbody id="queue-body"></tbody>
    </table>

    <hr/>
    <h5>Current serving: <span id="admin-serving">-</span></h5>
    <p class="small-muted">Click "Call Next" to call the smallest waiting number.</p>

    <hr>
    <h3 class="mt-4">Analytics</h3>
    <h5 class="mb-1">Average Waiting Time: <span id="avgWait" class="fw-bold">Calculating...</span></h5>
    <small class="small-muted">(based on history entries)</small>

    <canvas id="peakChart"></canvas>
  </div>

  <script>
  // ---------- FIREBASE CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBSPDes90ZSZgMm9cjFGe1DFlxKBPe24AE",
    authDomain: "virtual-queue-system-a1834.firebaseapp.com",
    databaseURL: "https://virtual-queue-system-a1834-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "virtual-queue-system-a1834",
    storageBucket: "virtual-queue-system-a1834.firebasestorage.app",
    messagingSenderId: "1081902069575",
    appId: "1:1081902069575:web:3e6d91288c8102c0743e62"
  };
  // -------------------------------------

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // UI elements
  const queueBody = document.getElementById('queue-body');
  const servingEl = document.getElementById('admin-serving');
  const avgWaitEl = document.getElementById('avgWait');
  const locationSelect = document.getElementById('admin-location');
  const callNextBtn = document.getElementById('callNextBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const peakCanvas = document.getElementById('peakChart');

  let peakChart = null;
  let listeners = [];

  function clearListeners() {
    listeners.forEach(l => l.off && l.off());
    listeners = [];
  }

  function attachListenersFor(queueName) {
    clearListeners();
    const queueRef = db.ref(`queues/${queueName}`);
    const servingRef = db.ref(`queues/${queueName}/serving`);
    const historyRef = db.ref(`queues/${queueName}/history`);
    const metaRef = db.ref(`queues/${queueName}/meta`);

    // Items listener
    const itemListener = queueRef.on('value', snap => {
      const data = snap.val() || {};
      renderTable(data);
    });
    listeners.push(queueRef);

    // Serving listener
    const serveListener = servingRef.on('value', snap => {
      const val = snap.val();
      servingEl.textContent = val ? (val.name ?? val.id ?? val.number ?? '-') : '-';
    });
    listeners.push(servingRef);

    // Analytics listeners
    const histListener = historyRef.on('value', snap => {
      const hist = snap.val() || {};
      updateAnalyticsFromHistory(hist);
    });
    listeners.push(historyRef);

    const metaListener = metaRef.on('value', snap => {
      const m = snap.val() || {};
      if (m.avgWaitMs != null)
        avgWaitEl.textContent = (Math.round((m.avgWaitMs / 60000) * 10) / 10) + ' mins (rolling)';
    });
    listeners.push(metaRef);
  }

  function renderTable(itemsObj) {
    queueBody.innerHTML = '';
    const entries = Object.entries(itemsObj || {});
    const normalized = entries
      .filter(([id, it]) => id !== "serving" && id !== "meta" && id !== "history") // skip system nodes
      .map(([id, it]) => {
        const ts = it.timestamp || (it.createdAt ? new Date(it.createdAt).getTime() : 0);
        const num = (it.number != null) ? Number(it.number) : null;
        return { id, it, ts, num };
      })
      .sort((a, b) => a.num - b.num);

    normalized.forEach(({id, it}) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.number ?? '-'}</td>
        <td>${escapeHtml(it.name ?? '-')}</td>
        <td>${escapeHtml(it.status ?? 'waiting')}</td>
        <td><button class="btn btn-sm btn-primary" data-id="${id}">Mark Served</button></td>`;
      queueBody.appendChild(tr);
      tr.querySelector('button').addEventListener('click', () => markServed(locationSelect.value, id, it));
    });
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function callNext(queueName) {
    const itemsSnapshot = await db.ref(`queues/${queueName}`).get();
    const items = itemsSnapshot.val() || {};
    const entries = Object.entries(items).filter(([id]) => !['serving','meta','history'].includes(id));
    if (!entries.length) return alert('Queue empty');

    entries.sort((a, b) => (a[1].number ?? 99999) - (b[1].number ?? 99999));
    const [bestKey, bestVal] = entries[0];

    const servingObj = {
      id: bestKey,
      name: bestVal.name ?? '',
      number: bestVal.number ?? null,
      timestamp: bestVal.timestamp ?? Date.now(),
      startedAt: Date.now()
    };

    await db.ref(`queues/${queueName}/serving`).set(servingObj);
  }

  async function markServed(queueName, itemId, itemData) {
    try {
      const now = Date.now();
      const joinTs = itemData.timestamp || now;
      const startedAt = itemData.startedAt || now;

      const servedRecord = { id: itemId, name: itemData.name, number: itemData.number, timestamp: joinTs, startedAt, servedAt: now };
      const waitMs = Math.max(0, startedAt - joinTs);

      const metaRef = db.ref(`queues/${queueName}/meta`);
      const metaSnap = await metaRef.get();
      const meta = metaSnap.val() || {};
      const newCount = (meta.countServed || 0) + 1;
      const newAvg = Math.round(((meta.avgWaitMs || 0) * (newCount - 1) + waitMs) / newCount);

      const updates = {};
      updates[`queues/${queueName}/history/${itemId}`] = servedRecord;
      updates[`queues/${queueName}/meta/avgWaitMs`] = newAvg;
      updates[`queues/${queueName}/meta/countServed`] = newCount;
      updates[`queues/${queueName}/${itemId}`] = null;
      updates[`queues/${queueName}/serving`] = null;

      await db.ref().update(updates);
    } catch (e) {
      alert('Error marking served: ' + e.message);
    }
  }

  function updateAnalyticsFromHistory(hist) {
    const arr = Object.values(hist || {});
    const waitMsArr = arr.map(h => (h.startedAt || h.servedAt) - h.timestamp).filter(x => x > 0);
    const avgMin = waitMsArr.length ? (waitMsArr.reduce((a,b)=>a+b)/waitMsArr.length)/60000 : 0;
    avgWaitEl.textContent = avgMin ? avgMin.toFixed(1) + ' mins' : '—';

    const counts = new Array(24).fill(0);
    arr.forEach(h => { const hr = new Date(h.servedAt).getHours(); counts[hr]++; });
    drawPeakChart(counts);
  }

  function drawPeakChart(counts) {
    const labels = counts.map((_,i)=>`${i}:00`);
    if (peakChart) peakChart.destroy();
    peakChart = new Chart(peakCanvas, {
      type: 'bar',
      data: { labels, datasets:[{label:'Users Served Per Hour',data:counts,backgroundColor:'rgba(54,162,235,0.6)'}]},
      options: { responsive:true, scales:{y:{beginAtZero:true}} }
    });
  }

  locationSelect.addEventListener('change', () => attachListenersFor(locationSelect.value));
  callNextBtn.addEventListener('click', () => callNext(locationSelect.value));
  refreshBtn.addEventListener('click', () => db.ref(`queues/${locationSelect.value}`).get().then(s => renderTable(s.val()||{})));

  attachListenersFor(locationSelect.value);
  </script>
</body>
</html>

